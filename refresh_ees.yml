---
- name: rerun EE's and sincy with container image repo
  hosts: "{{ target_hosts }}"
  vars: 
    registry_url: quay.io/mbredeme

  tasks:  
    - name: get EE list
      shell:
        cmd: ls -d */
        chdir: /home/mbredeme/execution_environments
      register: r_ee_list

    - name: show r_ee_list
      debug:
        var: item [:-1]
      loop: "{{ r_ee_list.stdout_lines }}"
      when: item [:-1] != 'roles'

    - name: login to registry.redhat.io to pull ubi default minimal
      shell:
        cmd: podman login -u {{ lookup('env', 'PORTAL_USERNAME') }} -p {{ lookup('env', 'PORTAL_PASSWORD') }} registry.redhat.io
        chdir: /home/mbredeme/execution_environments

    - name: build EE's
      shell:
        cmd: ansible-builder build -v3 -t {{ registry_url }}/{{ item [:-1] }}
        chdir: /home/mbredeme/execution_environments/{{ item [:-1] }}
      loop: "{{ r_ee_list.stdout_lines }}"
